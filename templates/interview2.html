
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview2 Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://kit.fontawesome.com/9fe3d1bfff.js" crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/9fe3d1bfff.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='intro.css') }}">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='font.css') }}">
    <style>
 .accordion-body {
          max-height: 200px; /* Adjust as needed */
          overflow: auto;
        }
        .form-group {
          display: flex;
          align-items: center;
          gap: 15px;
          position: relative;
          margin-bottom:3rem;
      }

      .label-container {
          display: flex;
          flex-direction: column; /* Stack label and star vertically */
          align-items: center; /* Center align the text and icon */
          position: relative;
      }

      .form-group label {
          font-size: 17px !important;
          font-weight: bold;
          gap: 2rem !important;
          color: #1AACAC;
          width:5rem;
      }

      .required-icon {
          font-size: 8px;
          color: red;
          position: absolute;
          top: -2.5rem; /* Moves the star above the label */
          left: 70%;
          transform: translateX(-50%);
      }
      input{
        height:3rem;
      }  
      .custom-select-box {
        
            background: #fff;
            padding: 10px;
            border: 1px solid #ced4da;
            cursor: pointer;
            position: relative;
            width: 100%;
            text-align: left;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #ced4da;
            width: 80%;
            z-index: 100;
            top: 60px;
            left:90px;
            padding: 10px;
             /* Limit height */
            overflow-y: auto; /* Add scroll if too many options */
        }

        .dropdown-content label {
            display: flex;
            align-items: center;
            padding: 5px;
            cursor: pointer;
            gap: 10px; /* Space between checkbox and text */
        }

        .dropdown-content input[type="checkbox"] {
            margin: 0; /* Remove extra margin */
            transform: scale(1.2); /* Make checkbox slightly larger */
        }

        .dropdown-content label:hover {
            background: #f1f1f1;
        }

        .show {
            display: block;
        }
        .panel-item {
    display: flex;
    align-items: center;
    padding: 5px 8px; /* Adjust padding */
    gap: 8px; /* Reduce gap between elements */
}

.panel-checkbox {
    margin-right: 5px; /* Reduce space between checkbox and text */
}

.panel-item label {
    flex-grow: 1; /* Ensures label takes remaining space */
    font-size: 16px;
    font-weight: bold;
    color: #1AACAC;
    white-space: nowrap; /* Prevents text from wrapping */
}

.delete-btn {
    background-color: red;
    color: white;
    border: none;
    cursor: pointer;
    padding: 3px 6px; /* Reduce button size */
    font-size: 14px;
    margin-left: auto; /* Pushes delete button to the right */
}

        #status {
    width: 100%; /* Same as Date input */
    height: 3rem; /* Match height */
    border: 1px solid #ced4da;
    border-radius: 5px;
    padding: 0 10px;
     }
     .status-container {
    position: relative;
    display: flex;
    align-items: center;
    width: 100%;
}
.status-container select {
    width: 100%;
    padding-right: 30px; /* Space for the arrow */
    appearance: none; /* Hide default arrow */
    -webkit-appearance: none;
    -moz-appearance: none;
}

/* .custom-select-box {
    position: relative;  /*  Keeps dropdown inside the parent */
    /* display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    cursor: pointer;
    border: 1px solid #ced4da;
    border-radius: 5px;
    background-color: white;
    width: 100%;  Matches the input field */
/* } */ 


.arrow {
    position: absolute;
    pointer-events: none;
    right: 10px;
    font-size: 16px;
    transition: transform 0.3s ease-in-out;
}

.custom-select-box {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    cursor: pointer;
    border: 1px solid #ced4da;
    border-radius: 5px;
    background-color: white;
    width: 100%; /* Ensure parent container is full width */
}

.dropdown-content {
    display: none;
    position: absolute;
    background: white;
    border: 0.1rem solid #ced4da;
    width: 80%;
    max-width: 80%;
    z-index: 100;
    padding: 1rem;
    max-height: 12.5rem; /* Equivalent to 200px */
    overflow-y: auto;
    left: 50%; /* Moves the dropdown to the center */
    transform: translateX(-50%); /* Adjust back to center */
    box-shadow: 0rem 0.25rem 0.375rem rgba(0, 0, 0, 0.1);
}





/* Rotating Arrow when Open */
.arrow-up {
    transform: rotate(180deg);
}

/* Flash Message Style */
.flash-message {
    text-align: center;
    background: linear-gradient(to right, #ffecd2, #fcb69f); /* Gradient background */
    color: #5a3f37; /* Elegant dark brown text */
    padding: 12px 20px;
    font-size: 15px;
    font-weight: bold;
    margin: 15px auto;
    border-radius: 8px;
    width: 60%; /* Adjust width */
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease-in-out;
    position: relative;
}

/* Add a fade-in effect */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.flash-message {
    animation: fadeIn 0.5s ease-in-out;
}

/* Close Button */
.flash-message::after {
    content: "Ã—";
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
    cursor: pointer;
    color: #5a3f37;
    font-weight: bold;
}

.flash-message::after:hover {
    color: red;
}

    </style>
    
  </head>
<body>

 
    
  <script>
    var status1="{{status1}}"
    var comments1="{{comments1}}"
    var selected_panel="{{selected_panel}}"
    var date="{{date}}"
    var addPanelUrl="{{ url_for('add_panel_member') }}"
  </script>
  <div style="display: flex;">
    {% include 'sidemenu.html'%}
    <div class="container" style="width: 950px;">

<!-- only after all the fields are filled -->
<div id="flash-messages"></div>

        <h1 class="headline">Enter L2 details</h1>
        <div style="margin-top:50px; width: 90%; margin-left:4%;">
            <form id="panelForm" action="{{ url_for('interview2v', resume_id=resume.id) }}" method="post" >
              <div class="form-group">
                    <label for="selectedPanel">Panel Member</label>
              
                  
<!-- Custom Select Box -->
<div class="custom-select-box form-control" id="panelSelectBox">
    <span id="selectedPanelText">Add panel</span>
    <span id="panelArrow" class="arrow">&#9660;</span> <!-- Default Down Arrow -->
</div>

<!-- Hidden Multi-Checkbox Dropdown -->
<div id="panelDropdown" class="dropdown-content">
    {% for panel in all_panels %}
        <div class="panel-item">
            <input type="checkbox" class="panel-checkbox" id="panel_{{ panel.name }}" data-email="{{ panel.email }}" value="{{ panel.name }}"
            {% if panel.name in selected_panels %} checked {% endif %}>
            <label for="panel_{{ panel.name }}">{{ panel.name }} ({{ panel.email }})</label>
            <button type="button" class="btn btn-danger btn-sm delete-btn" data-panel="{{ panel.name }}">
                <i class="fa-solid fa-trash"></i>
            </button>
        </div>
    {% endfor %}
</div>

                    <button type="button" class="btn btn-primary " data-bs-toggle="modal" data-bs-target="#panelModal">Add</button>  
                    <input type="hidden" id="selectedPanel" name="selectedPanel">
                </div>
                 
                <div class="modal fade" id="panelModal" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                      <div class="modal-content">
                          <div class="modal-header">
                              <h5 class="modal-title">Add Panel Member</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                          </div>
                          <div class="modal-body">
                              <input type="text" id="panelName" placeholder="Enter Name" class="form-control mb-2" value="">
                              <input type="email" id="panelEmail" placeholder="Enter Email" class="form-control mb-2" value=" ">
                          </div>
                          <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                              <button type="button" class="btn btn-success" id="savePanel">Save</button>
                          </div>
                      </div>
                  </div>
              </div>
                <div class="form-group">
                    
                      <label for="date" class="form-label" style="font-size:20px; color:#1AACAC;">Date<span style="color: red;">*</span></label>
                      
                    <input type="date" class="form-control" id="date" name="date" value="{{ date or '' }}" min="" required>
                </div>
              

                <div class="form-group">
                    <label for="status">Status<span style="color: red;">*</span></label>
                    <div class="status-container" onclick="toggleStatusDropdown()">
                        <select id="status" name="status" class="form-control" required>
                            <option value="Rejected" {{ 'selected' if status1 == 'Rejected' else '' }}>Rejected</option>
                            <option value="Move to HR Round" {{ 'selected' if status1 == 'Move to HR Round' else '' }}>Move to HR Round</option>
                            <option value="On Hold" {{ 'selected' if status1 == 'On Hold' else '' }}>On Hold</option>
                        </select>
                        <span id="statusArrow" class="arrow">&#9660;</span> <!-- Default Down Arrow -->
                    </div>
                </div>
                
                <div class="form-group" style="display: none;">
                    <label for="comments" class="form-label" style="font-size:15px !important;">Feedback</label>
                    <input class="form-control" type="text" name="comments" value="{{comments1}}" placeholder="Enter your feedback" required>
                </div>
                <div id="commentsSection">
                    {% for panel in selected_panels %}
                        <div class="form-group">
                            <label for="comment_{{ panel }}">{{ panel }} feedback </label>
                            <input 
                            type="text" 
                            id="comment_{{ panel }}" 
                            name="comment_{{ panel }}" 
                            class="form-control"
                            value="{{ comments_dict.get(panel, '') }}">
                        </div>
                    {% endfor %}
                </div>   
                <div style="display: flex; align-items: center; justify-content:center;">
                  <button type="submit" class="btn btn-primary" style="width:6rem; height:3rem; margin-right: 2rem;">Submit</button>
                  <a class="btn btn-outline-secondary" href="{{url_for('employee')}}" style=" padding:10px;width:6rem; height:3rem;">
                      <div style="display: flex; justify-content: space-between; padding:5px;">
                          <div>
                              <i class="fa-solid fa-backward" style="margin-right: 10px;"></i>
                          </div>
                          <div>Back</div>
                      </div>
                  </a>
                </div>
            </form>
        </div>
        <div style="margin-top: 20px;text-align: center; width: 75%; margin-left:15%;">
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              <div class="flash-messages">
                {% for category, message in messages %}
                  <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          {% endwith %}
          </div>

      </div>
  </div>
    
      <script src="{{ url_for('static', filename='intro.js') }}"></script> 
      <script src="{{ url_for('static', filename='modal.js') }}"></script> 

      <!-- date picker -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
    let today = new Date().toISOString().split("T")[0]; // Get today's date in YYYY-MM-DD format
    document.getElementById("date").setAttribute("min", today);
});

</script>


<!-- The email should auto-fill and stay locked even if the user types multiple words -->
<script>

    document.getElementById("panelName").addEventListener("input", function () {
        let nameInput = this.value.trim();
        let namePattern = /^[a-zA-Z\s]+$/; // Allow alphabets and spaces only
        let emailField = document.getElementById("panelEmail");
    
        if (namePattern.test(nameInput) && nameInput.length > 0) {
            let firstName = nameInput.split(" ")[0].toLowerCase(); // Extract only first word
    
            // If email is empty OR already auto-generated, lock it and set value
            if (!emailField.value || emailField.value.endsWith("@qaoncloud.com")) {
                emailField.value = firstName + "@qaoncloud.com";
                emailField.setAttribute("readonly", true); // Lock email field
            }
        } else {
            emailField.value = ""; // Clear email only if input is invalid
            emailField.removeAttribute("readonly"); // Unlock email if input is invalid
        }
    });
    
    </script>

      
<script>
    document.getElementById("panelSelectBox").addEventListener("click", function () {
        let dropdown = document.getElementById("panelDropdown");
        let arrow = document.getElementById("panelArrow");
    
        if (dropdown.style.display === "block") {
            dropdown.style.display = "none";
            arrow.classList.remove("arrow-up"); // Reset arrow direction
        } else {
            dropdown.style.display = "block";
            arrow.classList.add("arrow-up"); // Rotate arrow
        }
    });
    
    // Close dropdown when clicking outside
    document.addEventListener("click", function (event) {
        let dropdown = document.getElementById("panelDropdown");
        let selectBox = document.getElementById("panelSelectBox");
        let arrow = document.getElementById("panelArrow");
    
        if (!dropdown.contains(event.target) && !selectBox.contains(event.target)) {
            dropdown.style.display = "none";
            arrow.classList.remove("arrow-up"); // Reset arrow
        }
    });
    
    
    
    
    // status toggle
    function toggleStatusDropdown() {
        const statusSelect = document.getElementById("status");
        const statusArrow = document.getElementById("statusArrow");
    
        if (statusSelect.classList.contains("open")) {
            statusSelect.classList.remove("open");
            statusArrow.classList.remove("arrow-up");
        } else {
            statusSelect.classList.add("open");
            statusArrow.classList.add("arrow-up");
        }
    }
    
    // Close dropdown when clicking outside
    document.addEventListener("click", function (event) {
        const statusContainer = document.querySelector(".status-container");
        if (!statusContainer.contains(event.target)) {
            document.getElementById("status").classList.remove("open");
            document.getElementById("statusArrow").classList.remove("arrow-up");
        }
    });
    
    </script>
        <script>
        document.addEventListener("DOMContentLoaded", function () {
            const checkboxes = document.querySelectorAll(".panel-checkbox");
            const hiddenInput = document.getElementById("selectedPanel");
            const selectedPanelText = document.getElementById("selectedPanelText");
            const commentsSection = document.getElementById("commentsSection");
            const commentsDict = {{ comments_dict | tojson }};
    
            function updateSelectedPanels() {
                let selectedValues = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
    
                hiddenInput.value = selectedValues.join(",");
                selectedPanelText.textContent = selectedValues.length > 0 ? selectedValues.join(", ") : "Add Panel";
    
                // Clear existing comment boxes
                let existingComments = {};
            document.querySelectorAll("#commentsSection input").forEach(input => {
                existingComments[input.id] = input.value;
            });
    
            // Clear previous comment fields
            commentsSection.innerHTML = "";
    
            // Add new comment fields dynamically with preserved values
            selectedValues.forEach(panel => {
                let commentBox = document.createElement("div");
                commentBox.classList.add("form-group");
                commentBox.innerHTML = `
                    <label for="comment_${panel}">${panel} feedback<span style="color: red;">*</span></label>
                    <input 
                      type="text" 
                      id="comment_${panel}" 
                      name="comment_${panel}" 
                      class="form-control"
                      value="${existingComments[`comment_${panel}`] || ''}">
                `;
                commentsSection.appendChild(commentBox);
            });
        }
    
            // Attach event listeners to checkboxes
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener("change", updateSelectedPanels);
            });
    
            // Initialize with already selected values (if any)
            updateSelectedPanels();
        });
    
        // Toggle dropdown visibility
        function togglePanelDropdown() {
            let dropdown = document.getElementById("panelDropdown");
            dropdown.style.display = (dropdown.style.display === "block") ? "none" : "block";
        }
    
        // Close dropdown if clicking outside
        document.addEventListener("click", function (event) {
            let dropdown = document.getElementById("panelDropdown");
            let selectBox = document.querySelector(".custom-select-box");
            if (!dropdown.contains(event.target) && !selectBox.contains(event.target)) {
                dropdown.style.display = "none";
            }
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".delete-btn").forEach(button => {
            button.addEventListener("click", function () {
                let panelName = this.getAttribute("data-panel");
    
                if (confirm(`Are you sure you want to delete ${panelName}?`)) {
                    fetch("/delete_panel", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ panel: panelName })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Remove from UI
                            this.parentElement.remove();
                        } else {
                            alert("Failed to delete panel.");
                        }
                    })
                    .catch(error => console.error("Error:", error));
                }
            });
        });
    });
    </script>


<!-- all the fields are filled then only click submit button -->

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("panelForm").addEventListener("submit", function (event) {
            event.preventDefault(); // Stop form submission
    
            let isValid = true;
            let errorMessage = [];
    
            // Get form fields
            let panelMember = document.getElementById("selectedPanel");
            let date = document.getElementById("date");
            let status = document.getElementById("status");
            let feedbacks = document.querySelectorAll("input[name^='comment_']"); // Select all feedback fields
    
            // Function to check and highlight empty fields
            function validateField(field, fieldName) {
                if (!field || field.value.trim() === "") {
                    isValid = false;
                    errorMessage.push(`${fieldName} is required.`);
                }
            }
    
            // Validate all fields
            validateField(date, "Date");
            validateField(status, "Status");
    
            // Validate at least one panel member is selected
            if (!panelMember || panelMember.value.trim() === "") {
                isValid = false;
                errorMessage.push("Panel Member is required.");
            }
    
            // Validate all feedback fields
            feedbacks.forEach(function (feedback) {
                validateField(feedback, feedback.getAttribute("name"));
            });
    
            // Show error or submit form
            if (!isValid) {
                showFlashMessage(errorMessage.join("<br>"));
            } else {
                this.submit(); // Submit the form if all fields are filled
            }
        });
    
        function showFlashMessage(message) {
            let flashDiv = document.createElement("div");
            flashDiv.className = `flash-message`;
            flashDiv.innerHTML = `${message}`;
    
            document.getElementById("flash-messages").appendChild(flashDiv);
    
            // Remove the message after 2 seconds
            setTimeout(function () {
                flashDiv.remove();
            }, 2000);
        }
    });
    </script>

<!-- validation to ensure candidateName and candidateEmail are not null, undefined, or empty 
before sending the email. If either of them is missing, the script will show an alert and prevent email sending. -->


<script>
    document.addEventListener("DOMContentLoaded", function () {
      emailjs.init("qdP1EAfow-fwPes6j"); // EmailJS User ID


  });

  // Function to show a popup message
  function showPopup(message, type) {
      const popup = document.createElement("div");
      popup.innerText = message;
      popup.style.cssText = `
          position: fixed;
          top: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: ${type === "success" ? "green" : "red"};
          color: white;
          padding: 12px 20px;
          border-radius: 5px;
          font-size: 16px;
          font-weight: bold;
          z-index: 9999;
          box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
      `;
      document.body.appendChild(popup);

      setTimeout(() => popup.remove(), 3000); // Hide after 3 sec
  }



  function sendEmail(candidateName, candidateEmail, status, callback) {
  const submitButton = document.querySelector("button[type='submit']");
  submitButton.innerHTML = "Sending Email...";
  submitButton.disabled = true;

  if (!candidateName.trim() || !candidateEmail.trim()) {
      alert("âš ï¸ Candidate name and email are required!");
      console.error("âŒ Email not sent: Candidate name or email is missing.");
      submitButton.innerHTML = "Submit";
      submitButton.disabled = false;
      return;
  }

  const requiredFields = document.querySelectorAll("input[required], select[required], textarea[required]");
  for (let field of requiredFields) {
      if (!field.value.trim()) {
          alert("âš ï¸ All fields must be filled before submitting!");
          console.error(`âŒ Missing required field - ${field.name || field.id}`);
          submitButton.innerHTML = "Submit";
          submitButton.disabled = false;
          return;
      }
  }

  const toEmail = "shwethaacharya829@gmail.com";
  let ccEmails = Array.from(document.querySelectorAll(".panel-checkbox:checked"))
      .map(checkbox => checkbox.getAttribute("data-email"));

  const templateParams = {
      to_email: toEmail,
      cc_email: ccEmails.join(", "),
      candidate_name: candidateName,
      candidate_email: candidateEmail,
      interview_round: "Intro",
      Panel_feedback: document.getElementById("candidate_current_link")?.value || "N/A",
      candidate_phone: document.getElementById("candidate_phone")?.value || "1234567890",
      candidate_role: document.getElementById("candidate_role")?.value || "Software Engineer",
      candidate_experience: document.getElementById("candidate_experience")?.value || "3 years",
      candidate_location: document.getElementById("candidate_location")?.value || "Bangalore",
      candidate_notice_period: document.getElementById("candidate_notice_period")?.value || "30 days",
      candidate_actc: document.getElementById("candidate_actual_ctc")?.value || "8 LPA",
      candidate_ectc: document.getElementById("candidate_expected_ctc")?.value || "12 LPA",
      status: status,
      link: document.getElementById("candidate_next_link")?.value || "N/A",
      message: `Candidate ${candidateName} has been marked as '${status}'.`
  };

  console.log("ðŸ“¤ Sending email with params:", templateParams);

  emailjs.send("service_qghdq8f", "template_1jyba8e", templateParams)
      .then(response => {
          console.log("ðŸ“¨ Email sent successfully", response);
          alert("âœ… Email sent successfully!");
          if (callback) callback();
      })
      .catch(error => {
          console.error("âŒ Error sending email", error);
          alert("âš ï¸ Failed to send email. Please try again.");
          submitButton.innerHTML = "Submit";
          submitButton.disabled = false;
      });
}

document.addEventListener("DOMContentLoaded", function () {
  document.querySelector("form").addEventListener("submit", function (event) {
      event.preventDefault();
      const status = document.getElementById("status").value;

      // ðŸ”¹ Dummy values for testing
      const candidateName = "John Doe";
      // const candidateName = "";    // Uncomment this line to test missing name
      const candidateEmail = "johndoe@example.com";
      // const candidateEmail = "";   // Uncomment this line to test missing email

      console.log("ðŸ“ Candidate Info:", { candidateName, candidateEmail, status });

      if (!candidateName || !candidateEmail) {
          alert("âš ï¸ Candidate name and email are required!");
          console.error("âŒ Missing candidate details. Email not sent.");
          return;
      }
      
      if (status !== "Rejected") {
          sendEmail(candidateName, candidateEmail, status, () => event.target.submit());
      } else {
          console.log("ðŸš« Status is 'Rejected', skipping email.");
          event.target.submit();
      }
  });
});

</script>  


</body>

</html>